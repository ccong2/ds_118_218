<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-08-08">

<title>Applied Data Science for Cities - Geospatial Machine Learning with </title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Applied Data Science for Cities</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../lectures/index.html"> 
<span class="menu-text">Lectures</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../labs/index.html"> 
<span class="menu-text">Labs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resource.html"> 
<span class="menu-text">Resource</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#add-spatial-context-to-housing-price-prediction" id="toc-add-spatial-context-to-housing-price-prediction" class="nav-link" data-scroll-target="#add-spatial-context-to-housing-price-prediction">Add Spatial Context to Housing Price Prediction</a></li>
  <li><a href="#fit-a-decision-tree-model" id="toc-fit-a-decision-tree-model" class="nav-link" data-scroll-target="#fit-a-decision-tree-model">Fit a Decision Tree Model</a>
  <ul class="collapse">
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">Feature Importance</a></li>
  <li><a href="#tree-structure" id="toc-tree-structure" class="nav-link" data-scroll-target="#tree-structure">Tree structure</a></li>
  <li><a href="#parameter-tuning" id="toc-parameter-tuning" class="nav-link" data-scroll-target="#parameter-tuning">Parameter Tuning</a></li>
  </ul></li>
  <li><a href="#from-one-tree-to-a-forest" id="toc-from-one-tree-to-a-forest" class="nav-link" data-scroll-target="#from-one-tree-to-a-forest">From One Tree to a Forest</a>
  <ul class="collapse">
  <li><a href="#how-was-the-forest-formed" id="toc-how-was-the-forest-formed" class="nav-link" data-scroll-target="#how-was-the-forest-formed"><strong>How was the forest formed?</strong></a>
  <ul class="collapse">
  <li><a href="#how-many-trees-are-there-in-a-forest" id="toc-how-many-trees-are-there-in-a-forest" class="nav-link" data-scroll-target="#how-many-trees-are-there-in-a-forest"><strong>How many trees are there in a forest</strong></a></li>
  <li><a href="#how-many-predictors-each-tree-uses" id="toc-how-many-predictors-each-tree-uses" class="nav-link" data-scroll-target="#how-many-predictors-each-tree-uses"><strong>How many predictors each tree uses</strong></a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">Hyperparameter tuning</a></li>
  </ul></li>
  <li><a href="#two-ensemble-learning-methods" id="toc-two-ensemble-learning-methods" class="nav-link" data-scroll-target="#two-ensemble-learning-methods">Two Ensemble Learning Methods</a></li>
  </ul></li>
  <li><a href="#fit-a-boosted-tree" id="toc-fit-a-boosted-tree" class="nav-link" data-scroll-target="#fit-a-boosted-tree"><strong>Fit A Boosted Tree</strong></a>
  <ul class="collapse">
  <li><a href="#gbm-hyperparameters" id="toc-gbm-hyperparameters" class="nav-link" data-scroll-target="#gbm-hyperparameters">GBM Hyperparameters</a>
  <ul class="collapse">
  <li><a href="#what-are-they" id="toc-what-are-they" class="nav-link" data-scroll-target="#what-are-they">What are they</a></li>
  <li><a href="#how-to-tune" id="toc-how-to-tune" class="nav-link" data-scroll-target="#how-to-tune">How to tune</a></li>
  </ul></li>
  <li><a href="#gbm-feature-importance" id="toc-gbm-feature-importance" class="nav-link" data-scroll-target="#gbm-feature-importance">GBM Feature Importance</a></li>
  </ul></li>
  <li><a href="#model-summary" id="toc-model-summary" class="nav-link" data-scroll-target="#model-summary">Model Summary</a></li>
  <li><a href="#lab-report" id="toc-lab-report" class="nav-link" data-scroll-target="#lab-report">Lab Report</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Geospatial Machine Learning with <img src="../img/Rlogo.png" class="img-fluid" width="60"></h1>
<p class="subtitle lead"><span style="color:#2C3E50">11.118/11.218 Applied Data Science for Cities</span></p>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 8, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Last week, we saw how machine learning can be used for prediction, and that different models vary in their predictive accuracy. More flexible models, like random forests, tend to capture complex patterns better. This week, we’ll take a closer look at tree-based models, including decision trees, ensembles, and boosting methods. The spatial element is added and we will learn why generalizability across space is so important for geospatial machine learning.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rattle)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="add-spatial-context-to-housing-price-prediction" class="level1">
<h1>Add Spatial Context to Housing Price Prediction</h1>
<p>We’ll continue using the Boston housing price data to explore prediction models.<br>
Last time, we focused on building characteristics, following a typical hedonic model - a model that explains housing prices based on property features like size, age, or number of rooms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This part goes to the lecture</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>boston <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/boston_house_price_collapse.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, houses exist in space, and housing prices are not randomly distributed. Real estate transactions often show a spatial pattern, where nearby houses tend to have similar prices. This is known as spatial autocorrelation, the idea that “near things are more related than distant things.”</p>
<p>This week, we’ll try including a variable that represents “nearby prices” to see if it increases the variance explained and improves our predictions. In the following code, we create a new variable that captures the average housing price in nearby neighborhoods, an idea known as <strong>spatial lag</strong>.</p>
<p>Convert the dataset to a spatial feature using its longitude and latitude information:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>boston_sf <span class="ot">&lt;-</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  boston <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2249</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each house, draw a 500-meter buffer, identify all other houses within that buffer, and calculate their average price.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>boston_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(boston_sf, <span class="at">dist =</span> <span class="dv">1640</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Parcel_No, SalePrice)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>neighbors <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(boston_sf, boston_buffer)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ave_price <span class="ot">&lt;-</span> neighbors <span class="sc">|&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Parcel_No <span class="sc">!=</span> Parcel_No<span class="fl">.1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Parcel_No) <span class="sc">|&gt;</span>  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Ave_Neighbor =</span> <span class="fu">mean</span>(SalePrice<span class="fl">.1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This average is then joined back to the original dataset as a new variable, giving each house a sense of its local price context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>boston_with_splag <span class="ot">&lt;-</span> boston_sf <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ave_price, <span class="at">by =</span> <span class="st">"Parcel_No"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>boston_with_splag <span class="ot">&lt;-</span>  boston_with_splag <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ave_Neighbor =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(Ave_Neighbor) <span class="sc">~</span> SalePrice,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> Ave_Neighbor</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-a-decision-tree-model" class="level1">
<h1>Fit a Decision Tree Model</h1>
<p>Here we repeat the modeling workflow from last time. First identify the variables we want to include. Then handle data issues such as rare categories and outliers. After cleaning the data, we split it into training and test sets to prepare for modeling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>modeldata <span class="ot">&lt;-</span> boston_with_splag <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Parcel_No, PricePerSq, LU, R_BLDG_STY))  <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Style <span class="sc">!=</span> <span class="st">"Unknown"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SalePrice <span class="sc">&lt;</span> <span class="dv">5000000</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>train_index <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> modeldata<span class="sc">$</span>SalePrice,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> .<span class="dv">7</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">list =</span> <span class="cn">FALSE</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> modeldata[ train_index,]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> modeldata[<span class="sc">-</span>train_index,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we’ve seen with the <code>caret</code> package, we can fit different models by changing the <code>"method"</code> argument in <code>train()</code>. Here, we fit a basic decision tree model by setting <code>method = "rpart"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tree_model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> .,        </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train_data,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"rpart"</span>,        </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneLength =</span> <span class="dv">6</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculate the RMSE. Even with a simple decision tree, the prediction got much better than last time’s random forest model, just by adding the spatial lag variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_model, <span class="at">newdata =</span> test_data) </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>tree_result <span class="ot">=</span> <span class="fu">RMSE</span>(pred, test_data<span class="sc">$</span>SalePrice)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>tree_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 202977.8</code></pre>
</div>
</div>
<section id="feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="feature-importance">Feature Importance</h3>
<p><code>varImp()</code> shows the importance of each variable in a model. In a tree-based model context, variable importance is measured by how much a variable reduces error (e.g., decreases node impurity) when used to split the data.</p>
<p>Our spatial lag variable <code>Ave_Neighbor</code> ranks the highest among the predictors. The importance score is relative, meaning a variable scored 2.0 contributed twice as much a variable with a score of 1.0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tree_model_importance <span class="ot">&lt;-</span> <span class="fu">varImp</span>(tree_model, <span class="at">scale =</span> <span class="cn">FALSE</span>) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_model_importance, <span class="at">top =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab9_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="tree-structure" class="level3">
<h3 class="anchored" data-anchor-id="tree-structure">Tree structure</h3>
<p>A tree model is considered a “white-box” model, because we can easily see the if-then-else rules it uses to make predictions. At each split, the tree decides which variable to use and what value is appropriate for the split. Each path leads to a smaller group that is more homogeneous in terms of housing price.</p>
<p>Each box typically shows three numbers: predicted value, % of total data, and number of observations. For instance, at #2 node, 571,982 is the average of the housing price variable in this group, n=1005 is the number of observations that fall in this group, and 97% means this number of observations takes up 97% of the entire dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  tree_model<span class="sc">$</span>finalModel,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Simple Decision Tree Model"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sub =</span> <span class="st">"Boston Housing Sales"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="sc">-</span><span class="dv">3</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab9_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="parameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="parameter-tuning">Parameter Tuning</h3>
<p>A decision tree can technically keep growing until each leaf is pure (i.e., contains only one class or exact value). However, as the tree grows deeper, its splitting rules become increasingly specific. Initially, the splits capture meaningful patterns in the data, but later ones often reflect only noise. This leads to overfitting. To prevent this, we need to decide when to stop growing the tree.</p>
<p>The tree model includes an internal complexity parameter (cp), which serves as a form of regularization. This parameter adds a penalty for each additional split:</p>
<ul>
<li>A higher cp means more restriction (fewer splits, simpler tree).</li>
<li>A lower cp allows more splits (risking overfitting).</li>
</ul>
<p>You can specify <code>cp</code> directly in the <code>train()</code> function, or let caret automatically test a range of <code>cp</code> values to find the one that gives the best predictive performance.</p>
<p>In your <code>tree_model</code> results, you’ll see a list of tested <code>cp</code> values. For example, we have set <code>tuneLength = 6</code>, so <code>caret</code> tried 6 different <code>cp</code> values. For each one, it uses 5-fold cross-validation to estimate the performance. After training, it reports: “The final value used for the model was cp = xxx”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tree_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CART 

1036 samples
  14 predictor

No pre-processing
Resampling: Cross-Validated (5 fold) 
Summary of sample sizes: 829, 828, 830, 829, 828 
Resampling results across tuning parameters:

  cp          RMSE      Rsquared   MAE     
  0.00943124  194878.8  0.8465393  130397.0
  0.01244752  199303.3  0.8374178  134003.3
  0.02585317  214115.0  0.8109520  143219.5
  0.05757983  252965.7  0.7548125  153943.8
  0.10196885  284744.4  0.6644264  178483.1
  0.66917205  411661.0  0.5775574  226671.5

RMSE was used to select the optimal model using the smallest value.
The final value used for the model was cp = 0.00943124.</code></pre>
</div>
</div>
<p>The <code>plot(tree_model)</code> displays the model performance (e.g., RMSE) for each tested value of <code>cp</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab9_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="from-one-tree-to-a-forest" class="level1">
<h1>From One Tree to a Forest</h1>
<p>In 1906, statistician Francis Galton observed a contest to guess an ox’s weight. There were 800 guesses, and while the individual guesses varied widely, the average was within 1% of the true weight. This “wisdom of crowds” idea, explored by James Surowiecki, also applies to predictive models: combining multiple models (an ensemble) is often more accurate than relying on just one.</p>
<p>Random forest is an <strong>ensemble</strong> model made up of many decision trees. Each tree makes its own prediction, and the final result is based on averaging (for regression) or majority vote (for classification). The randomness both in selecting data and variables helps reduce overfitting and improves the model’s ability to generalize to new data.</p>
<p><img src="../img/lab9_forest.jpg" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> .,        </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train_data,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"rf"</span>,        </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneLength =</span> <span class="dv">6</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model, <span class="at">newdata =</span> test_data) </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>rf_result <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(pred, test_data<span class="sc">$</span>SalePrice)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>rf_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 143326.3</code></pre>
</div>
</div>
<p>With the spatial variable, this random forest model produce better result (RMSE 143,326.3) compared with last week (RMSE ~234,360).</p>
<section id="how-was-the-forest-formed" class="level2">
<h2 class="anchored" data-anchor-id="how-was-the-forest-formed"><strong>How was the forest formed?</strong></h2>
<p>Random forest is built through two stages of random sampling. Each tree is trained on a random subset of the data, and at each split, each tree randomly selects a subset of predictors to consider. This added variation across trees mimics the wisdom of crowds: each tree sees a different part of the data and contributes its own “opinion,” leading to more stable and generalizable predictions.</p>
<section id="how-many-trees-are-there-in-a-forest" class="level3">
<h3 class="anchored" data-anchor-id="how-many-trees-are-there-in-a-forest"><strong>How many trees are there in a forest</strong></h3>
<p>In the <code>caret</code> package, the number of trees in a random forest is controlled by the <code>ntree</code> parameter. You can pass it through the <code>train()</code> function. The default value is 500.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  ntree = 500</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="how-many-predictors-each-tree-uses" class="level3">
<h3 class="anchored" data-anchor-id="how-many-predictors-each-tree-uses"><strong>How many predictors each tree uses</strong></h3>
<p><code>mtry</code> controls how many predictors are randomly selected and considered at each split in a tree. The random forest model in <code>caret</code> automatically tunes the <code>mtry</code> hyperparameter, meaning the model tests different values to see which one gives the best predictive performance.</p>
<p>In your model result below (<code>rf_model</code>), <code>mtry</code> shows the number of predictors randomly selected at each split of a tree. It tested 6 <code>mtry</code> values, because we have specified <code>tuneLength = 6</code> in the <code>train()</code> function. After the 6 attempts, the the model says “The final value used for the model was mtry = 27.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>rf_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest 

1036 samples
  14 predictor

No pre-processing
Resampling: Cross-Validated (5 fold) 
Summary of sample sizes: 828, 828, 829, 831, 828 
Resampling results across tuning parameters:

  mtry  RMSE      Rsquared   MAE      
   2    270273.4  0.7978104  150634.58
   7    187092.3  0.8770591  106331.33
  12    167880.8  0.8913759  100677.57
  17    161211.3  0.8981539   99603.43
  22    158843.8  0.8978341   99384.06
  27    158736.9  0.8963383   99674.57

RMSE was used to select the optimal model using the smallest value.
The final value used for the model was mtry = 27.</code></pre>
</div>
</div>
<p>The <code>plot(rf_model)</code> displays the model performance (e.g., RMSE) for each tested value of <code>mtry</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rf_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab9_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">Hyperparameter tuning</h3>
<p>Now we begin to see that machine learning models come with <strong>hyperparameters</strong>. Models learn patterns from data, they can behave differently depending on how they’re set up. A model can give you a random guess (underfitting)or try to accurately fit every single point (overfitting). What we want is a balance: a model that captures the real underlying patterns, but not the noise.</p>
<p>Hyperparameters are the “knobs” we use to tune that balance between accuracy and generalizability. Unlike parameters that are learned from the data (like coefficients in linear regression), hyperparameters are set by the users or selected through tuning (like <code>cp</code> in a decision tree, or <code>mtry</code> in a random forest).</p>
<p>If you’re not satisfied with the default values that the model tries, or if you want to test specific values (such 2, 4, 6, 8), you can manually tune them by specifying a tuning grid using the <code>tuneGrid</code> argument in the <code>train()</code> function:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a># Fit the model with your custom grid</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>rf_model &lt;- train(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  tuneGrid = expand.grid(mtry = c(2, 4, 6, 8)),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="two-ensemble-learning-methods" class="level2">
<h2 class="anchored" data-anchor-id="two-ensemble-learning-methods">Two Ensemble Learning Methods</h2>
<p><strong>Bagging</strong></p>
<p>We mentioned each decision tree is trained on a different subset of the training data. This process is called <strong>bagging</strong>, short for <strong>bootstrap aggregating</strong>. It works by randomly sampling the original training data with replacement, meaning the same observation can be selected multiple times.</p>
<p>The statistical term bootstrapping comes from the phrase “to pull oneself up by one’s bootstraps”, reflecting the idea that we generate many new datasets by resampling from the original data, without needing new data.</p>
<p><strong>Boosting</strong></p>
<p>While bagging builds many trees in parallel, <strong>boosting</strong> builds trees <strong>sequentially</strong>, where each new tree is trained to correct the mistakes made by the previous one. Both bagging and boosting are ensemble methods, they aggregate the outputs of multiple models, just in different ways</p>
<p>In boosting, the idea is to focus learning on the “hard” cases. The first tree might make many mistakes, and the second tree then tries to fix those mistakes by giving more weight to the misclassified or poorly predicted observations. This process continues, with each tree trained to minimize the residual error from the combined model so far.</p>
</section>
</section>
<section id="fit-a-boosted-tree" class="level1">
<h1><strong>Fit A Boosted Tree</strong></h1>
<p>One of the most commonly used boosting algorithms is the <strong>Gradient Boosted Machine (GBM)</strong>. GBM builds trees one at a time and each new tree is trained to predict the residuals (i.e., the remaining errors) from the current ensemble of trees.</p>
<p><img src="../img/lab9_gbm.png" class="img-fluid"></p>
<p>Use the <code>method = "gbm"</code> for a Gradient Boosted Machine model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>gbm_model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> .,        </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train_data,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"gbm"</span>,        </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneLength =</span> <span class="dv">3</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(gbm_model, <span class="at">newdata =</span> test_data) </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>gbm_result <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(pred, test_data<span class="sc">$</span>SalePrice)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>gbm_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 142774.8</code></pre>
</div>
</div>
<section id="gbm-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="gbm-hyperparameters">GBM Hyperparameters</h2>
<p><a href="https://topepo.github.io/caret/available-models.html">This table</a> shows all the models available in train(), along with their tunable parameters. For example, you can look up <code>rpart</code> and see that its tuning parameter is <code>cp</code>, and for <code>rf</code> (random forest), it’s <code>mtry</code>.</p>
<p>If you scroll down to <code>gbm</code> (boosted tree model), you’ll notice it has four tuning parameters.</p>
<section id="what-are-they" class="level3">
<h3 class="anchored" data-anchor-id="what-are-they">What are they</h3>
<ul>
<li><strong>n.trees:</strong> the number of trees in the (sequenced) ensemble (typical number: 50-500)</li>
<li><strong>interaction.depth:</strong> the maximum depth of each individual tree (usually start with 1-5)</li>
<li><strong>shrinkage:</strong> learning rate. how much each tree contributes to the final prediction. smaller value means slow learning. (Typical values: 0.01, 0.05, 0.1)</li>
<li><strong>n.minobsinnode:</strong> Minimum observations in terminal nodes. how small the leaf nodes (terminal nodes) can be. If this subpartition is trival, then stop it. Higher: less complicated trees. (Typical values: 10)</li>
</ul>
<p>With more tuning knobs, it mean GBMs are prone to overfitting. It’s tempting to adjust to fit the training data very well. If it fits the training data too well, it loses generalbility</p>
</section>
<section id="how-to-tune" class="level3">
<h3 class="anchored" data-anchor-id="how-to-tune">How to tune</h3>
<p><strong>1.Let the model choose (automatic tuning):</strong> We mentioned we can set up <code>tuneLength</code> in the <code>train</code> function. In the previous example, we have set <code>tuneLength = 3</code>, the model automatically selected 3 values for each of the most influential parameter.</p>
<p>In our case, both <code>n.trees</code> (number of trees) and <code>interaction.depth</code> (tree depth) were varied, each with 3 values. This led to a total of 3 × 3 = 9 combinations, which you can see in the result table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gbm_model<span class="sc">$</span>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  shrinkage interaction.depth n.minobsinnode n.trees     RMSE  Rsquared
1       0.1                 1             10      50 219364.0 0.8420349
4       0.1                 2             10      50 202008.2 0.8568887
7       0.1                 3             10      50 193100.0 0.8633882
2       0.1                 1             10     100 207917.4 0.8522571
5       0.1                 2             10     100 188575.1 0.8659353
8       0.1                 3             10     100 186397.0 0.8691328
3       0.1                 1             10     150 203157.6 0.8555506
6       0.1                 2             10     150 182642.5 0.8719976
9       0.1                 3             10     150 183749.3 0.8717811
       MAE   RMSESD RsquaredSD    MAESD
1 123631.8 21014.13 0.07218021 6894.726
4 113605.3 18676.79 0.05863182 3698.699
7 108567.7 22721.83 0.05961338 2748.247
2 117687.1 22009.86 0.06230836 4904.312
5 110150.1 15023.60 0.05295433 2653.846
8 106545.5 19020.91 0.05349108 3606.791
3 117843.7 17405.58 0.05745362 3946.568
6 108353.7 16029.87 0.04942192 4009.147
9 106603.3 14395.91 0.04824818 3646.324</code></pre>
</div>
</div>
<p><strong>2.Manual tuning (full control):</strong> If you want more control, you can manually define the grid of values using <code>tuneGrid = expand.grid(...)</code> . The model will then try all possible combinations of the values you provide.</p>
<p>In the following code, I set up a grid where I will use a deeper tree (<code>interaction.depth</code>), and test it against 2 values of total number of trees (<code>n.trees</code>). This custom tuning improved our test RMSE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gbm_Grid <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(<span class="at">n.trees =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>),  </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">interaction.depth =</span> <span class="dv">5</span>,     </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">shrinkage =</span> <span class="fl">0.1</span>,   </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">n.minobsinnode =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>gbm_model_tuned <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> .,        </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train_data,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"gbm"</span>,        </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> gbm_Grid,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(gbm_model_tuned, <span class="at">newdata =</span> test_data) </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>gbm_tuned_result <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(pred, test_data<span class="sc">$</span>SalePrice)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>gbm_tuned_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 140898.6</code></pre>
</div>
</div>
<p>Again, we can see all the value combinations that the model used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gbm_model_tuned<span class="sc">$</span>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  shrinkage interaction.depth n.minobsinnode n.trees     RMSE  Rsquared
1       0.1                 5             10      50 194408.7 0.8634318
2       0.1                 5             10     100 186034.2 0.8668271
       MAE   RMSESD RsquaredSD    MAESD
1 109854.7 21113.45 0.05437980 4906.340
2 107333.1 15643.44 0.04977026 4106.315</code></pre>
</div>
</div>
<p>However, trying too many combinations isn’t always necessary or helpful. Different models vary in how sensitive they are to tuning. Sometimes, it’s perfectly fine to stop at a solution that is “good enough”, especially when speed and simplicity matters.</p>
</section>
</section>
<section id="gbm-feature-importance" class="level2">
<h2 class="anchored" data-anchor-id="gbm-feature-importance">GBM Feature Importance</h2>
<p>We can also plot the variable importance of the GBM model using <code>varImp()</code>. The spatial lag variable still ranks among the most important predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>gbm_model_importance <span class="ot">&lt;-</span> <span class="fu">varImp</span>(gbm_model_tuned, <span class="at">scale =</span> <span class="cn">FALSE</span>) </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We can also visualize the most important features in our model this way...</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gbm_model_importance, <span class="at">top =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab9_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-summary" class="level1">
<h1>Model Summary</h1>
<p>Here are the models we’ve tried today. Model complexity, when properly regularized and tuned, can lead to better predictive performance. But it’s equally important to understand how these models actually work, so we can choose and apply them with purpose.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 38%">
<col style="width: 61%">
</colgroup>
<thead>
<tr class="header">
<th>Model Type</th>
<th>RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Decision Tree</td>
<td>202,977.8</td>
</tr>
<tr class="even">
<td>Random Forest</td>
<td>143,326.3</td>
</tr>
<tr class="odd">
<td>Gradient Boosted Machine</td>
<td>142,774.8</td>
</tr>
<tr class="even">
<td>Gradient Boosted Machine (with tuning)</td>
<td>140,898.6</td>
</tr>
</tbody>
</table>
</section>
<section id="lab-report" class="level1">
<h1>Lab Report</h1>
<p>For this homework, continue working with the Ames Housing dataset and improve the best model you built previously by adding spatial contexts and apply tree-based models.</p>
<ul>
<li>First, include a variable related to location information in your dataset. This could be a spatial lag variable, or a categorical neighborhood variable (as in Steif’s book chapter).</li>
<li>Then, apply both Random Forest and Gradient Boosted Tree models, adjusting a few key tuning parameters using either <code>tuneLength</code> or a custom <code>tuneGrid</code>. Try different settings to find the model that performs best based on test RMSE.</li>
</ul>
<p>What is the best model you’ve built after exploring different machine learning methods over the past two weeks? Take some time to reflect on your work and <strong>prepare a report</strong> sharing your findings.</p>
<p>In your report, tell us which model performed best based on test RMSE and explain why you think it stood out. Describe the different models you tried, what you liked or didn’t like about them, and any adjustments you made along the way like tuning parameters, selecting features, or creating variables. Please include any helpful tables or graphs that show your results, such as comparisons of RMSE values or visualizations that illustrate your model’s performance.</p>
<p>Keep your report clear and straightforward so anyone reading it can easily follow your process and reasoning. We’re excited to see what you discovered!</p>
<p>Please prepare your report in a Quarto document and submit your Rendered HTML file to Canvas by the end of day, Tuesday, Sep 23.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Made with R and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>